## UTF-8 Support for Metric and Label names

* **Owners:**
  * `<@author: owen.williams@grafana.com>`

* **Implementation Status:** `Proof-of-concept implemented`

* **Related Issues and PRs:**
  * [GH Issue](https://github.com/prometheus/prometheus/issues/12630)
  * [PR](https://github.com/grafana/mimir-prometheus/pull/476) (TODO needs to be moved)

* **Other docs or links:**
  * [Background Discussion / Justification](https://docs.google.com/document/d/1yFj5QSd1AgCYecZ9EJ8f2t4OgF2KBZgJYVde-uzVEtI/edit).  Please read this document first for more information on the chosen solution.

> TL;DR: We propose to add support for the UTF-8 characters in Prometheus metric and label names. While tsdb and the Prometheus code already support arbitrary strings, PromQL and the exposition format need a quoting syntax to make these values distinguishable.

## Why

We wish to use Prometheus as a backing database for other metrics implementations like Open Telemetry that use Prometheus-illegal characters, like '.'. Establishing a quoting syntax avoids the need for verbose and unreadable character encoding schemes, as well as non-roundtripable replacement schemes like using underscore for all unsupported characters.

### Pitfalls of the current solution

The current recommendation is to replace all unsupported characters with underscores. This substitution cannot be reversed, creating possible name collisions. Furthermore, the change in metric names between original write and eventual read can be confusing for end users.

## Goals

* Allow arbitrarily-named metrics and labels to be submitted to Prometheus.
* Allow these metric and label names to be easily queried back with PromQL.
* Ensure that Go templating supports quoted label names.
* Provide a graceful backwards-compatible fallback for query clients that do not support UTF-8 metric and label names in returned results.

### Audience

The audience for this change is very broad. It would allow all end-users of Prometheus to use richer metric names. Tool and service authors will want to be aware of the change and support the new character set.

## Non-Goals

We do not directly address the issue of adding function-like syntaxes, such as `metricname.sum`. The changes proposed here should be forward-compatible with such a new syntax, as long as the new syntax is outside of the quoted metric names.

We do not propose a syntax for selecting metric names other than by basic equality. The changes proposeed here would be forward-compatible with ways of doing that, for instance operator prefixes on the quoted metric name.

## How

### Differences between PromQL and Openmetrics Exposition

Changes will need to be made to PromQL and the exposition format. It is important to note that while these two languages have surface similarities, there are important differences between them that need to be accounted for:

* Quotes:
  * In PromQL, strings may be quoted with single or double quotes. Strings may also be quoted with backticks to avoid escape sequences (raw strings).
  * The exposition format only supports double quotes.
* Equal Sign:
  * In PromQL, the equal sign (`=`) is a label matching operator, and there are other label matching operators for other operations.
  * In the exposition format, the equal sign is an assignment operator that sets a label to a specific value.
* String Escaping:
  * PromQL strings are unquoted using the Go strconv.Unquote function
  * In the exposition format, characters are escaped with a custom backslash format.

### PromQL Syntax

We propose the following change in syntax to PromQL and the exposition format:

* Label names may be quoted, either just double for the exposition format, or single/double/backticked for PromQL.
* A quoted string inside the label set (`{}`) without a label matching operator is default-assigned to the label name `__name__` (the metric name).
* Two strings without a label matching operator is a syntax error.
* Style prefers, but does not enforce, that the string without a label matching operator is the first term in the label set.
* Strings in quotes will be unquoted using the mechanism for each language: strconv.Unquote for PromQL, and the OpenMetrics escaping mechanism for the exposition format.
* In the exposition format, the TYPE, HELP, and UNIT lines can have double quotes around the metric name and similarly use Go quoting.

### Syntax Examples:

* Basic quoted metric: `{"my.dotted.metric", region="east"}`

* Quoted label name: `{"my.dotted.metric", "http.status"=~"5.."}`

* Classic metrics do not need to be treated differently:
`sum(rate(regular_metric{region="east"}[5m]))`

* If the user decides to put a classic metric inside the selector, it still needs to be quoted:
`sum(rate({"regular_metric", region="east"}[5m]))`

* Escape syntax if the metric has a quote: `sum(rate({"my \"quoted\" metric", region="east"}[5m]))`.

* Recording Rule Syntax: `sum(rate({"my.dotted.metric:errors:rate5m", region="east"}[5m]))`. Recording rule syntax is a naming convention, not a programmatically-meaningful operator syntax.

* Unicode escaping: `{"emoji metric: ðŸ’© or \u1F4A9"}`

* Possible future Native Histogram syntaxes (not being proposed here):
  `{"my.metric.with.periods", region="east"}.sum`
  `{"my.metric.with.periods".sum, region="east"}`

* Possible future metric name operator syntax via prefixes (not being proposed here):
  `{~"a\.regex.*selector.*", region="east"}`

### Templating syntax

Go templating already supports quoting by way of the `index` keyword.  Whereas labels are usually denoted as `{{ $labels.my_label_name }}`, the quote syntax is `{{ index $labels "my.label.name" }}`. Tests will be added to confirm this format.

### Backwards-compatibility

There a few situations where we need to consider backwards compatibility:

1. Old metrics provider, new backend: Old providers will not serve utf8 metric names, so nothing needs to be done here.
2. New metrics provider, old backend: Old versions of Prometheus will throw an error if they see the new syntax. Therefore we must provide a way for the agent to serve invalid metrics in a form that the old database can process.
3. New backend, old query client: Errors will occur if an old client is fed UTF-8 metric names. Therefore we must provide a way for Prometheus to quote metric names such that old clients can query for and read them.
4. Old backend, new query client: as with the first case, nothing needs to be done.

#### Scrape Time

Prometheus can scrape metrics either via HTTP text or protobuf.

In the case of text scraping, we propose a version bump in the (TextVersion and OpenMetricsVersion numbers)[https://github.com/prometheus/common/blob/main/expfmt/expfmt.go] so that a Prometheus scraper can signal its support of the new syntaxes. For TextVersion, this would be version 0.0.5. For OpenMetrics this would either be version 1.1.0 or 2.0.0, depending on whether this is considered a breaking change.

For protobuf scraping, we would add a new parameter to the content-type tuple list, perhaps `validchars=utf8`.

Replies to clients not providing these values would be escaped with the Text Escaping method described above.

#### Query Time

Prometheus will also need to support queries and responses from old query clients that do not support the new syntax. We will create a new boolean HTTP header called AllowUTF8Names. When this value is true in the request, and the feature is enabled in prometheus, UTF-8 support will be enabled. For any client that does not pass the AllowUTF8Names header, any HTTP request that can return metric names (including simple queries) will have the UTF-8 metric names escaped.



### HTTP quoting

The HTTP endpoints will need to support HTTP-unquoting metric names in the URL parameters and POST data of HTTP API calls that take metric names as an argument.



### Implementation

Implementing this feature will require updates to several Prometheus libraries. These updates will be written so that functionality does not change for existing users and builds, and will only be enabled when certain flags are flipped or options turned on.  There will be minimal read-only backwards compatibility for clients that do not support the new supported character set and syntax.

Main tasks:

* Add flags / options to libraries and binaries to enable the new behavior.
* Change / update code locations that check for a valid metric name, based on the flag setting.
* Update text generators to generate the new syntax when a metric must be quoted.
* Update parsers to parse the new syntax.
* Add an HTTP header so that clients can indicate their support for UTF-8.
* Add a tuple term to the protobuf content type so clients can indicate their support for UTF-8.
* Add a way to escape metric names for clients that do not support the full character set.
* Update endpoint code to support HTTP-unquoting metric names in the URL parameters and POST data of HTTP API calls that take metric names as an argument.

### prometheus/common

We will add a boolean argument to model.IsValidMetricName that switches validation logic to allow UTF-8 names (and therefore will only check for 0 length). Because this is a public function, all users of this library will need to add an argument to their call sites.

openmetrics_create.go and text_create.go will detect if the metric names require quoting, and if so, use
the new syntax when creating the formatted text.

Other repositories that use this check to filter out "bad" metric names will have to be optional via a flag or argument.

### prometheus/client_golang

The golang library checks that metrics have a valid name when NewDesc is called. We can create a new parallel function, NewDescUTF8 (or similar) that will bypass the validity check.

### prometheus/prometheus

All support for UTF-8 will be behind a default-off configuration flag. Behavior will not be changed unless this flag is on.

Prometheus itself needs updates to its lexers and parsers to support reading the new exposition syntax and promql syntax:

* openmetricslex (openmetrics exposition format)
* promlex (prometheus exposition format)
* generated_parser (PromQL parsing)
* parser.ts (validation for text input fields)



## Alternatives

### Non-quoted metric names

`my.dotted.metric{label="value"}`

While this syntax could be made to work with simple additional characters like dots, it does not fulfill the goal of full UTF-8 support, which would include `{` or other special characters without a verbose and less-readable escaping mechanism, e.g.

  `my.dotted.metric\{with\ braces\ and\ spaces\}{foo="bar"}`.

Versus our selected approach:

  `{"my.dotted.metric{with braces and spaces}", foo="bar"}`

Selecting this approach would introduce a convenient syntax for only a small new subset of UTF-8, so a quoting mechanism would still be needed for the full character set. Rather than implement this half-improvement we decided to only support a full quoting approach.

Furthermore, the dot has been reserved for over a decade as a potential operator for PromQL with a likely forthcoming application in Native Histograms.

### Quoted metric names outside curly braces

`"my.dotted.metric"{"label"="value"}`

While quoted strings are literals in PromQL, the combination of string+"{}" is currently an invalid syntax, so we could feasibly use this approach. There was concern that this syntax posed a greater threat of issues with existing queries in the wild because string literals are suddenly also instance vector selectors, so we decided to go with the safer approach of moving everything inside the curly braces.

See the [Discussion Doc](https://docs.google.com/document/d/1yFj5QSd1AgCYecZ9EJ8f2t4OgF2KBZgJYVde-uzVEtI/edit#heading=h.bpkufz5d0juo) for more exploration of this approach and why it was rejected.

### Backticked metric names outside the curly braces

``` `my.dotted.metric`{"label"="value"}```

Single, double, and backtick quotes are nearly equivalent in PromQL so this would just be the same as the above approach, or require changing the meaning of a particular quote character in a way that would break backward-compatibility. (Backticks prevent processing of escape sequences, which is otherwise enabled, see [PromQL documentation](https://prometheus.io/docs/prometheus/latest/querying/basics/#string-literals) for details.)

For new users, it might be confusing to parse this syntax visually, with a brace in the middle of a series of quoted values. The previous syntax resembles a function call, the way that `foo{bar}` is like `foo(bar)`. By adding the additional quotes this frame of reference is lost. It seems more intuitive to think of the brace as **the characters that surround the parameters for selecting data**, where the "metric name" is one special case of that kind of selector. This is similar to the approach chosen for [LogQL](https://grafana.com/docs/loki/latest/query/) and [TraceQL](https://grafana.com/docs/tempo/latest/traceql/), which do not have a special case "metric name" equivalent and thus have no items outside the curly braces.

### VictoriaMetrics approach

VictoriaMetrics has extended PromQL for UTF-8 Support, calling the updated language [MetricsQL](https://docs.victoriametrics.com/MetricsQL.html):

> * Metric names and label names may contain any unicode letter. For example Ñ‚ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð°{Ð³Ð¾Ñ€Ð¾Ð´="ÐšÐ¸ÐµÐ²"} is a value MetricsQL expression.
> * Metric names and labels names may contain escaped chars. For example, foo\-bar{baz\=aa="b"} is valid expression. It returns time series with name foo-bar containing label baz=aa with value b. Additionally, the following escape sequences are supported:
>   * \xXX, where XX is hexadecimal representation of the escaped ascii char.
>   * \uXXXX, where XXXX is a hexadecimal representation of the escaped unicode char.

By allowing non-escaped dots, they risk colliding with planned Native Histogram function calls (like "`.count`"). Or they might require those to be escaped, resulting in many backslashes as in our own non-quoted rejected approach.  We do plan to adopt the \u approach via unquoting as described above.

## Action Plan

1. Make necessary updates to common and client_golang, with flags / parameters as needed to preserve existing functionality.
2. Make updates to Prometheus and Grafana Agent.
3. Launch as experimental feature, default off.
4. Once stable and debugged, make UTF-8 the default (with fallback escaping for old clients always supported).

