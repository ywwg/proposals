## UTF8 Support for Metric and Label names

* **Owners:**
  * `<@author: owen.williams@grafana.com>`

* **Implementation Status:** `Proof-of-concept implemented`

* **Related Issues and PRs:**
  * [GH Issue](https://github.com/prometheus/prometheus/issues/12630)
  * [PR](https://github.com/grafana/mimir-prometheus/pull/476) (TODO needs to be moved)

* **Other docs or links:**
  * [Background Discussion / Justification](https://docs.google.com/document/d/1yFj5QSd1AgCYecZ9EJ8f2t4OgF2KBZgJYVde-uzVEtI/edit).  Please read this document first for more information on the chosen solution.

> TL;DR: We propose to add support for the UTF8 characters in Prometheus metric and label names. While tsdb and the Prometheus code already support arbitrary strings, PromQL and the exposition format need a quoting syntax to make these values distinguishable.

## Why

We wish to use Prometheus as a backing database for other metrics implementations like Open Telemetry that use Prometheus-illegal characters, like '.'. Establishing a quoting syntax avoids the need for verbose and unreadable character encoding schemes, as well as non-roundtripable replacement schemes like using underscore for all unsupported characters.

### Pitfalls of the current solution

The current recommendation is to replace all unsupported characters with underscores. This substitution cannot be reversed, creating possible name collisions. Furthermore, the change in metric names between original write and eventual read can be confusing for end users.

## Goals

* Allow arbitrarily-named metric and label names to be submitted to Prometheus.
* Allow these metric and label names to be easily queried back with PromQL.
* Ensure that Go templating supports quoted label names.
* Provide a graceful backwards-compatible fallback for query clients that do not support UTF8 metric and label names in returned results.

### Audience

The audience for this change is very broad. It would allow all end-users of Prometheus to use richer metric names. Tool and service authors will want to be aware of the change and support the new character set.

## Non-Goals

We do not directly address the issue of adding function-like syntaxes, such as `metricname.sum`. The changes proposed here should be forward-compatible with such a new syntax, as long as the new syntax is outside of the quoted metric names.

We do not propose a syntax for selecting metric names other than by basic equality. The changes proposeed here would be forward-compatible with ways of doing that, for instance operator prefixes on the quoted metric name.

## How

We propose the following change in syntax to PromQL and the exposition format:

* Label names may be quoted
* A quoted string inside the label set (`{}`) without an operator is default-assigned to the label name `__name__` (the metric name).
* Style prefers, but does not enforce, that the operatorless string is the first term in the label set.
* Strings in double quotes will be unquoted using Go strconv.Unquote, so Go escaping can be used.
* In the exposition format, the TYPE, HELP, and UNIT lines can have quotes around the metric name and similarly use Go quoting.

### Syntax Examples:

* Basic quoted metric: `{"my.dotted.metric", region="east"}`

* Quoted label name: `{"my.dotted.metric", "http.status"=~"5.."}`

* Classic metrics do not need to be treated differently:
`sum(rate(regular_metric{region="east"}[5m]))`

* If the user decides to put a classic metric inside the selector, it still needs to be quoted:
`sum(rate({"regular_metric", region="east"}[5m]))`

* Syntax if the metric has a quote: `sum(rate({'my "quoted" metric', region="east"}[5m]))`

* Recording Rule Syntax: `sum(rate({"my.dotted.metric:errors:rate5m", region="east"}[5m]))`

* Unicode escaping: `{"emoji metric: ðŸ’© or \u1F4A9"}`

* Possible future Native Histogram syntaxes (not being proposed here):
  `{"my.metric.with.periods", region="east"}.sum`
  `{"my.metric.with.periods".sum, region="east"}`

* Possible future metric name operator syntax via prefixes (not being proposed here):
  `{~"a\.regex.*selector.*", region="east"}`

### Implementation

Implementing this feature will require updates to several Prometheus libraries. These updates will be written so that functionality does not change for existing users and builds, and will only be enabled when certain flags are flipped or options turned on.  There will be minimal read-only backwards compatibility for clients that do not support the new supported character set and syntax.

Main tasks:

* Add flags / options to libraries and binaries to enable the new behavior.
* Change / update code locations that check for a valid metric name, based on the flag setting.
* Update text generators to generate the new syntax when a metric must be quoted.
* Update parsers to parse the new syntax.
* Add an HTTP header so that clients can indicate their support for UTF8.
* Add a way to escape metric names for clients that do not support the full character set.
* Update endpoint code to support html-unquoting metric names in http API calls.

### prometheus/common

We will add a boolean argument to model.IsValidMetricName that switches validation logic to allow UTF8 names (and therefore will only check for 0 length). Because this is a public function, all users of this library will need to add an argument to their call sites.

openmetrics_create.go and text_create.go will detect if the metric names require quoting, and if so, use 
the new syntax when creating the formatted text.

Other repositories that use this check to filter out "bad" metric names will have to be optional via a flag or argument.

### prometheus/client_golang

The golang library checks that metrics have a valid name when NewDesc is called. We can create a new parallel function, NewDescUTF8 (or similar) that will bypass the validity check.

### prometheus/prometheus

All support for UTF8 will be behind a default-off configuration flag. Behavior will not be changed unless this flag is on.

Prometheus itself needs updates to its lexers and parsers to support reading the new exposition syntax and promql syntax:

* openmetricslex
* promlex
* generated_parser

#### Backwards-compatibility

Prometheus will also need to support queries and responses from old clients that do not support the new syntax. We will create a new boolean HTTP header called AllowUTF8Names. When this value is true in the request, and the feature is enabled in prometheus, UTF8 support will be enabled. For any client that does not pass the AllowUTF8Names header, any HTTP request that can return metric names (including simple queries) will have the UTF8 metric names escaped. 

#### Text escaping

We propose an escaping syntax for metric names that contain UTF8 characters:

* Prefix the string with `U__`
* All UTF8 characters will be encoded as underscores surrounding the unicode value, like `_1F60A_`
* All pre-existing underscores will become doubled: `__`
* If a string should start with "U__" already, it will need to be escaped: `U___55_____`. (That's `U__` + `_55_` + `__` + `__`)

#### HTTP escaping

The HTTP endpoints will need to support html unescaping metric names where they occur.

### Mimir

All support for UTF8 will be behind a default-off configuration flag. Behavior will not be changed unless this flag is on.

Mimir has a check in ValidateLabels for valid metric names that will need to be updated to support the new AllowUTF8Names header (in addition to the existing SkipLabelNameValidation header, which does not skip validation for metric names.

### Grafana Agent

The Agent will need a flag or config option to enable use of UTF8 names.

## Alternatives

### Non-quoted metric names

`my.dotted.metric{label="value"}`

While this syntax could be made to work with simple additional characters like dots, it does not fulfill the goal of full UTF8 support, which would include `{` or other special characters without a verbose and unreadable escaping mechanism. Selecting this approach would introduce a convenient syntax for only a small new subset of UTF8, so a quoting mechanism would still be needed for the full character set. Rather than implement this half-improvement we decided to only support a full quoting approach.

### Quoted metric names outside the braces

`"my.dotted.metric"{"label"="value"}`

While quoted strings are literals in PromQL, the combination of string+"{}" is currently an invalid syntax, so we could feasibly use this approach. There was concern that this syntax posed a greater threat of issues with existing queries in the wild because string literals are suddenly also instance vector selectors, so we decided to go with the safer approach of moving everything inside the braces.

See the [Discussion Doc](https://docs.google.com/document/d/1yFj5QSd1AgCYecZ9EJ8f2t4OgF2KBZgJYVde-uzVEtI/edit#heading=h.bpkufz5d0juo) for more exploration of this approach.

### Backticked metric names outside the braces

``` `my.dotted.metric`{"label"="value"}```

Single, double, and backtick quotes are nearly equivalent in PromQL so this would just be the same as the above approach, or require changing the meaning of a particular quote character in a way that would break backward-compatibility. (Backticks prevent processing of escape sequences, which is otherwise enabled, see [PromQL documentation](https://prometheus.io/docs/prometheus/latest/querying/basics/#string-literals) for details.)

## Action Plan

1. Make necessary updates to common and client_golang, with flags / parameters as needed to preserve existing functionality.
2. Make updates to Prometheus and Grafana Agent.
3. Launch as experimental feature, default off.
4. Once stable and debugged, make UTF8 the default.

